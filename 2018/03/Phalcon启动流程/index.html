<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Phalcon 启动流程 | To be a Web Artisan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="原文链接：https://avnpc.com/pages/phalcon-mvc-process 入口文件为public/index.php，简化后一共5行，包含了整个Phalcon的启动流程，以下将按顺序说明 12345require  __DIR__ . &apos;/../config/services.php&apos;;$application = new Phalcon\Mvc\Application()">
<meta name="keywords" content="phalcon">
<meta property="og:type" content="article">
<meta property="og:title" content="Phalcon 启动流程">
<meta property="og:url" content="https://liluoao.github.io/2018/03/Phalcon启动流程/index.html">
<meta property="og:site_name" content="To be a Web Artisan">
<meta property="og:description" content="原文链接：https://avnpc.com/pages/phalcon-mvc-process 入口文件为public/index.php，简化后一共5行，包含了整个Phalcon的启动流程，以下将按顺序说明 12345require  __DIR__ . &apos;/../config/services.php&apos;;$application = new Phalcon\Mvc\Application()">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-05-08T02:52:05.053Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Phalcon 启动流程">
<meta name="twitter:description" content="原文链接：https://avnpc.com/pages/phalcon-mvc-process 入口文件为public/index.php，简化后一共5行，包含了整个Phalcon的启动流程，以下将按顺序说明 12345require  __DIR__ . &apos;/../config/services.php&apos;;$application = new Phalcon\Mvc\Application()">
<meta name="twitter:creator" content="@liluoao">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">To be a Web Artisan</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">文章列表</a>
        
          <a class="main-nav-link" href="/categories/laravel">Laravel</a>
        
          <a class="main-nav-link" href="/categories/phalcon">Phalcon</a>
        
          <a class="main-nav-link" href="/categories/wechat">Wechat</a>
        
          <a class="main-nav-link" href="/me.html">关于作者</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://liluoao.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Phalcon启动流程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/Phalcon启动流程/" class="article-date">
  <time datetime="2018-03-15T02:37:19.000Z" itemprop="datePublished">2018-03-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/phalcon/">phalcon</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Phalcon 启动流程
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>原文链接：<a href="https://avnpc.com/pages/phalcon-mvc-process" target="_blank" rel="noopener">https://avnpc.com/pages/phalcon-mvc-process</a></p>
<p>入口文件为<code>public/index.php</code>，简化后一共5行，包含了整个Phalcon的启动流程，以下将按顺序说明</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span>  <span class="keyword">__DIR__</span> . <span class="string">'/../config/services.php'</span>;</span><br><span class="line">$application = <span class="keyword">new</span> Phalcon\Mvc\Application();</span><br><span class="line">$application-&gt;setDI($di);</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../config/modules.php'</span>;</span><br><span class="line"><span class="keyword">echo</span> $application-&gt;handle()-&gt;getContent();</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="DI注册阶段"><a href="#DI注册阶段" class="headerlink" title="DI注册阶段"></a>DI注册阶段</h2><p>Phalcon的所有组件服务都是通过<a href="http://docs.phalconphp.com/en/latest/api/Phalcon_DI.html" target="_blank" rel="noopener">DI（依赖注入）</a>进行组织的，这也是目前大部分主流框架所使用的方法。通过DI，可以灵活的控制框架中的服务：哪些需要启用，哪些不启用，组件的内部细节等等，因此Phalcon是一个松耦合可替换的框架，完全可以通过DI替换MVC中任何一个组件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../config/services.php'</span>;</span><br></pre></td></tr></table></figure>
<p>这个文件中默认注册了<code>Phalcon\Mvc\Router</code>（路由）、<code>Phalcon\Mvc\Url</code>（Url）、<code>Phalcon\Session\Adapter\Files</code>（Session）三个最基本的组件。同时当MVC启动后，DI中默认注册的服务还有很多，可以通过DI得到所有当前已经注册的服务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$services = $application-&gt;getDI()-&gt;getServices();</span><br><span class="line"><span class="keyword">foreach</span> ($services <span class="keyword">as</span> $key =&gt; $service) &#123;</span><br><span class="line">   var_dump($key);</span><br><span class="line">   var_dump(get_class($application-&gt;getDI()-&gt;get($key)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印看到Phalcon还注册了以下服务：</p>
<ul>
<li><code>dispatcher</code> : <code>Phalcon\Mvc\Dispatcher</code> 分发服务，将路由命中的结果分发到对应的Controller</li>
<li><code>modelsManager</code> : <code>Phalcon\Mvc\Model\Manager</code> Model管理</li>
<li><code>modelsMetadata</code> : <code>Phalcon\Mvc\Model\MetaData\Memory</code> ORM表结构</li>
<li><code>response</code> : <code>Phalcon\Http\Response</code> 响应</li>
<li><code>cookies</code> : <code>Phalcon\Http\Response\Cookies</code> Cookies</li>
<li><code>request</code> : <code>Phalcon\Http\Request</code> 请求</li>
<li><code>filter</code> : <code>Phalcon\Filter</code> 可对用户提交数据进行过滤</li>
<li><code>escaper</code> : <code>Phalcon\Escaper</code> 转义工具</li>
<li><code>security</code> : <code>Phalcon\Security</code> 密码Hash、防止CSRF等</li>
<li><code>crypt</code> : <code>Phalcon\Crypt</code> 加密算法</li>
<li><code>annotations</code> : <code>Phalcon\Annotations\Adapter\Memory</code> 注解分析</li>
<li><code>flash</code> : <code>Phalcon\Flash\Direct</code> 提示信息输出</li>
<li><code>flashSession</code> : <code>Phalcon\Flash\Session</code> 提示信息通过Session延迟输出</li>
<li><code>tag</code> : <code>Phalcon\Tag</code> View的常用Helper</li>
</ul>
<p>而每一个服务都可以通过DI进行替换。接下来实例化一个标准的MVC应用，然后将我们定义好的DI注入进去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$application = <span class="keyword">new</span> Phalcon\Mvc\Application();</span><br><span class="line">$application-&gt;setDI($di);</span><br></pre></td></tr></table></figure>
<h2 id="模块注册阶段"><a href="#模块注册阶段" class="headerlink" title="模块注册阶段"></a>模块注册阶段</h2><p>与DI一样，Phalcon建议通过引入一个独立文件的方式注册所有需要的模块：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../config/modules.php'</span>;</span><br></pre></td></tr></table></figure>
<p>这个文件的内容如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$application-&gt;registerModules(<span class="keyword">array</span>(    </span><br><span class="line">   <span class="string">'frontend'</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'className'</span> =&gt;<span class="string">'Eva\Frontend\Module'</span>,</span><br><span class="line">        <span class="string">'path'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../apps/frontend/Module.php'</span></span><br><span class="line">    )</span><br><span class="line">));</span><br></pre></td></tr></table></figure>
<p>可以看到Phalcon所谓的模块注册，其实只是告诉框架MVC模块的引导文件<code>Module.php</code>所在位置及类名是什么。</p>
<h2 id="MVC阶段"><a href="#MVC阶段" class="headerlink" title="MVC阶段"></a>MVC阶段</h2><p><code>$application-&gt;handle()</code>是整个MVC的核心，这个函数中处理了路由、模块、分发等MVC的全部流程，处理过程中在关键位置会通过事件驱动触发一系列<code>application:</code>事件，方便外部注入逻辑，最终返回一个<code>Phalcon\Http\Response</code>。整个<code>handle</code>方法的过程并不复杂，下面按顺序介绍：</p>
<h3 id="基础检查"><a href="#基础检查" class="headerlink" title="基础检查"></a>基础检查</h3><p>首先检查DI，如果没有任何DI注入，会抛出错误</p>
<blockquote>
<p>A dependency injection object is required to access internal services</p>
</blockquote>
<p>然后从DI启动EventsManager，并且通过EventsManager触发事件<code>application:boot</code></p>
<h3 id="路由阶段"><a href="#路由阶段" class="headerlink" title="路由阶段"></a>路由阶段</h3><p>接下来进入路由阶段，从DI中获得路由服务<code>router</code>，将uri传入路由并调用路由的<a href="http://docs.phalconphp.com/en/latest/api/Phalcon_Mvc_Router.html" target="_blank" rel="noopener"><code>handle()</code>方法</a>。</p>
<p>路由的handle方法负责将一个uri根据路由配置，转换为相应的Module、Controller、Action等，这一阶段接下来会检查路由是否命中了某个模块，并通过<code>Router-&gt;getModuleName()</code>获得模块名。</p>
<p>如果模块存在，则进入模块启动阶段，否则直接进入分发阶段。</p>
<p>注意到了么，在Phalcon中，<strong>模块启动是后于路由的</strong>，这意味着Phalcon的模块功能比较弱，我们无法在某个未启动的模块中注册全局服务，甚至无法简单的在当前模块中调用另一个未启动模块。这可能是Phalcon模块功能设计中最大的问题，解决方法暂时不在本文的讨论范围内，以后会另开文章介绍。</p>
<h4 id="模块启动"><a href="#模块启动" class="headerlink" title="模块启动"></a>模块启动</h4><p>模块启动时首先会触发<code>application:beforeStartModule</code>事件。事件触发后检查模块的正确性，根据<code>modules.php</code>中定义的<code>className</code>、<code>path</code>等，将模块引导文件加载进来，并调用模块引导文件中必须存在的方法</p>
<ul>
<li><code>Phalcon\Mvc\ModuleDefinitionInterface-&gt;registerAutoloaders ()</code></li>
<li><code>Phalcon\Mvc\ModuleDefinitionInterface-&gt;registerServices (Phalcon\DiInterface $dependencyInjector)</code></li>
</ul>
<p><code>registerAutoloaders()</code>用于注册模块内的命名空间实现自动加载。<code>registerServices ()</code>用于注册模块内服务，在官方示例中<code>registerServices ()</code>注册并定义了<code>view</code>服务以及模板的路径，并且注册了数据库连接服务<code>db</code>并设置数据库的连接信息。</p>
<p>模块启动完成后触发 <code>application:afterStartModule</code>事件，进入分发阶段</p>
<h3 id="分发阶段（Dispatch）"><a href="#分发阶段（Dispatch）" class="headerlink" title="分发阶段（Dispatch）"></a>分发阶段（Dispatch）</h3><p>分发过程由<code>Phalcon\Mvc\Dispatcher</code>（分发器）来完成，所谓分发，在Phalcon里本质上是分发器根据路由命中的结果，调用对应的Controller/Action，最终获得Action返回的结果。</p>
<p>分发开始前首先会准备View，虽然View理论上位于MVC的最后一环，但是如果在分发过程中出现任何问题，通常都需要将问题显示出来，因此View必须在这个环节就提前启动。Phalcon没有准备默认的View服务，需要从外部注入，在多模块demo中，View的注入官方推荐在模块启动阶段完成的。如果是单模块应用，则可以在最开始的DI阶段注入。</p>
<p>如果始终没有View注入，会抛出错误</p>
<blockquote>
<p>Service ‘view’ was not found in the dependency injection container</p>
</blockquote>
<p>导致分发过程直接中断。</p>
<p>分发需要Dispatcher，Dispatcher同样从DI中取得。然后将router中得到的参数（NamespaceName / ModuleName / ControllerName / ActionName / Params），全部复制到Dispatcher中。</p>
<p>分发开始前，会调用View的<code>start()</code>方法。具体可以参考<a href="http://docs.phalconphp.com/en/latest/reference/views.html#hierarchical-rendering" target="_blank" rel="noopener">View相关文档</a>，其实<code>Phalcon\Mvc\View-&gt;start()</code>就是PHP的输出缓冲函数<code>ob_start</code>的一个简单封装，分发过程中所有输出都会被暂存到缓冲区。</p>
<p>分发开始前还会触发事件<code>application:beforeHandleRequest</code>。</p>
<p>正式开始分发会调用<code>Phalcon\Mvc\Dispatcher-&gt;dispatch()</code>。</p>
<h4 id="Dispatcher内的分发处理"><a href="#Dispatcher内的分发处理" class="headerlink" title="Dispatcher内的分发处理"></a>Dispatcher内的分发处理</h4><p>进入Dispatcher后会发现Dispatcher对整个分发过程进行了进一步细分，并且在分发的过程中会按顺序触发非常多的<a href="http://docs.phalconphp.com/en/latest/reference/dispatching.html#dispatch-loop-events" target="_blank" rel="noopener">分发事件</a>，可以通过这些分发事件进行更加细致的流程控制。部分事件提供了可中断的机制，只要返回<code>false</code>就可以跳过Dispatcher的分发过程。</p>
<p>由于分发中可以使用<code>Phalcon\Mvc\Dispatcher-&gt;forward()</code>来实现Action的复用，因此分发在内部会通过循环实现，通过检测一个全局的<code>finished</code>标记来决定是否继续分发。当以下几种情况时，分发才会结束：</p>
<ul>
<li>Controller抛出异常</li>
<li><code>forward</code>层数达到最大（256次）</li>
<li>所有的Action调用完毕</li>
</ul>
<h3 id="渲染阶段-View-Render"><a href="#渲染阶段-View-Render" class="headerlink" title="渲染阶段 View Render"></a>渲染阶段 View Render</h3><p>分发结束后会触发<code>application:afterHandleRequest</code>，接下来通过<code>Phalcon\Mvc\Dispatcher-&gt;getReturnedValue()</code>取得分发过程返回的结果并进行处理。</p>
<p>由于Action的逻辑在框架外，Action的返回值是无法预期的，因此这里根据返回值是否实现<code>Phalcon\Http\ResponseInterface</code>接口进行区分处理。</p>
<h4 id="当Action返回一个非Phalcon-Http-ResponseInterface类型"><a href="#当Action返回一个非Phalcon-Http-ResponseInterface类型" class="headerlink" title="当Action返回一个非Phalcon\Http\ResponseInterface类型"></a>当Action返回一个非<code>Phalcon\Http\ResponseInterface</code>类型</h4><p>此时认为返回值无效，由View自己重新调度Render过程，会触发<code>application:viewRender</code>事件，同时从Dispatcher中取得ControllerName / ActionName / Params作为<code>Phalcon\Mvc\View-&gt;render()</code>的入口参数。</p>
<p>Render完毕后调用<code>Phalcon\Mvc\View-&gt;finish()</code>结束缓冲区的接收。</p>
<p>接下来从DI获得resonse服务，将<code>Phalcon\Mvc\View-&gt;getContent()</code>获得的内容置入response。</p>
<h4 id="当Action返回一个Phalcon-Http-ResponseInterface类型"><a href="#当Action返回一个Phalcon-Http-ResponseInterface类型" class="headerlink" title="当Action返回一个Phalcon\Http\ResponseInterface类型"></a>当Action返回一个<code>Phalcon\Http\ResponseInterface</code>类型</h4><p>此时会将Action返回的Response作为最终的响应，不会重新构建新的Response。</p>
<h3 id="返回响应"><a href="#返回响应" class="headerlink" title="返回响应"></a>返回响应</h3><p>通过前面的流程，无论中间经历了多少分支，最终都会汇总为唯一的响应。此时会触发<code>application:beforeSendResponse</code>，并调用</p>
<ul>
<li><code>Phalcon\Http\Response-&gt;sendHeaders()</code></li>
<li><code>Phalcon\Http\Response-&gt;sendCookies()</code></li>
</ul>
<p>将http的头部信息先行发送。至此，<code>Application-&gt;handle()</code>对于请求的处理过程全部结束，对外返回一个<code>Phalcon\Http\Response</code>响应。</p>
<h3 id="发送响应"><a href="#发送响应" class="headerlink" title="发送响应"></a>发送响应</h3><p>HTTP头部发送后一般把响应的内容也发送出去：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> $application-&gt;handle()-&gt;getContent();</span><br></pre></td></tr></table></figure>
<p>这就是Phalcon Framework的完整MVC流程。</p>
<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><p>分析MVC的启动流程，无疑是希望对流程有更好的把握和控制，方法有两种：</p>
<h3 id="自定义启动"><a href="#自定义启动" class="headerlink" title="自定义启动"></a>自定义启动</h3><p>按照上面的流程，我们其实完全可以自己实现<code>$application-&gt;handle()-&gt;getContent()</code>这一流程，下面就是一个简单的替代方案，代码中暂时没有考虑事件的触发。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Roter</span></span><br><span class="line">$router = $di[<span class="string">'router'</span>];</span><br><span class="line">$router-&gt;handle();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Module handle</span></span><br><span class="line">$modules = $application-&gt;getModules();</span><br><span class="line">$routeModule = $router-&gt;getModuleName();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($modules[$routeModule])) &#123;   </span><br><span class="line">   $moduleClass = <span class="keyword">new</span> $modules[$routeModule][<span class="string">'className'</span>]();</span><br><span class="line">   $moduleClass-&gt;registerAutoloaders();    </span><br><span class="line">   $moduleClass-&gt;registerServices($di);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//dispatch</span></span><br><span class="line">$dispatcher = $di[<span class="string">'dispatcher'</span>];</span><br><span class="line">$dispatcher-&gt;setModuleName($router-&gt;getModuleName());</span><br><span class="line">$dispatcher-&gt;setControllerName($router-&gt;getControllerName());</span><br><span class="line">$dispatcher-&gt;setActionName($router-&gt;getActionName());</span><br><span class="line">$dispatcher-&gt;setParams($router-&gt;getParams());</span><br><span class="line"></span><br><span class="line"><span class="comment">//view</span></span><br><span class="line">$view = $di[<span class="string">'view'</span>];</span><br><span class="line">$view-&gt;start();</span><br><span class="line">$controller = $dispatcher-&gt;dispatch();</span><br><span class="line"><span class="comment">//Not able to call render in controller or else will repeat output</span></span><br><span class="line">$view-&gt;render(</span><br><span class="line">    $dispatcher-&gt;getControllerName(),    </span><br><span class="line">    $dispatcher-&gt;getActionName(),    </span><br><span class="line">    $dispatcher-&gt;getParams()</span><br><span class="line">);</span><br><span class="line">$view-&gt;finish();</span><br><span class="line"></span><br><span class="line">$response = $di[<span class="string">'response'</span>];</span><br><span class="line">$response-&gt;setContent($view-&gt;getContent());</span><br><span class="line">$response-&gt;sendHeaders();</span><br><span class="line"><span class="keyword">echo</span> $response-&gt;getContent();</span><br></pre></td></tr></table></figure>
<h3 id="流程清单"><a href="#流程清单" class="headerlink" title="流程清单"></a>流程清单</h3><p>为了方便查找，将整个流程整理为一个树形清单如下：</p>
<ul>
<li>初始化DI (config/services.php) <code>$di = new FactoryDefault();</code><ul>
<li>设置路由 <code>$di[&#39;router&#39;] = function () {}</code></li>
<li>设置URL <code>$di[&#39;url&#39;] = function () {}</code></li>
<li>设置Session <code>$di[&#39;session&#39;] = function () {}</code></li>
</ul>
</li>
<li>初始化Application (public/index.php)<ul>
<li>实例化App <code>$application = new Application();</code></li>
<li>注入DI <code>$application-&gt;setDI($di);</code></li>
<li>注册模块 (config/modules.php) <code>$application-&gt;registerModules()</code></li>
</ul>
</li>
<li>启动Application (ext/mvc/application.c) <code>$application-&gt;handle()</code><ul>
<li>检查DI</li>
<li>触发事件 <code>application:boot</code></li>
<li>路由启动 <code>$di[&#39;router&#39;]-&gt;handle()</code></li>
<li>获得模块名 <code>$moduleName = $di[&#39;router&#39;]-&gt;getModuleName()</code>，如果没有则从 <code>$application-&gt;getDefaultModule</code>获取</li>
<li>模块启动 (如果路由命中)<ul>
<li>触发事件 <code>application:beforeStartModule</code></li>
<li>调用模块初始化方法 (Module.php) <code>registerAutoloaders()</code> 以及 <code>registerServices()</code></li>
<li>触发事件 <code>application:afterStartModule</code></li>
</ul>
</li>
<li>分发<ul>
<li>初始化View</li>
<li>初始化Dispatcher，将Router中的参数复制到Dispatcher</li>
<li>调用View <code>View-&gt;start()</code>开启缓冲区</li>
<li>触发事件 <code>application:beforeHandleRequest</code></li>
<li>开始分发 (etc/dispatcher.c) <code>Dispatcher-&gt;dispatch()</code><ul>
<li>触发事件 <code>dispatch:beforeDispatchLoop</code></li>
<li>循环开始单次分发<ul>
<li>触发事件 <code>dispatch:beforeDispatch</code></li>
<li>根据Dispatcher携带的Module、Namespace、Controller、Action获得完整的类与方法名，如果找不到则触发事件 <code>dispatch:beforeException</code></li>
<li>触发事件 <code>dispatch:beforeExecuteRoute</code></li>
<li>调用<code>Controller-&gt;beforeExecuteRoute()</code></li>
<li>调用<code>Controller-&gt;initialize()</code></li>
<li>触发事件 <code>dispatch:afterInitialize</code></li>
<li>调用Action方法</li>
<li>触发事件 <code>dispatch:afterExecuteRoute</code></li>
<li>触发事件 <code>dispatch:afterDispatch</code></li>
</ul>
</li>
<li>Action内如果有forward()，开始下一次分发</li>
</ul>
</li>
<li>全部分发结束，触发事件 <code>dispatch:afterDispatchLoop</code></li>
<li>Application获得分发后的输出 <code>$dispatcher-&gt;getReturnedValue()</code></li>
<li>触发事件 <code>application:afterHandleRequest</code> 分发结束</li>
</ul>
</li>
<li>渲染，Appliction如果从分发拿到<code>Phalcon\Http\ResponseInterface</code>类型的返回，则渲染直接结束<ul>
<li>触发事件 <code>application:viewRender</code> 分发结束</li>
<li>调用 <code>Phalcon\Mvc\View-&gt;render()</code>，入口参数为Dispatcher的 ControllerName / ActionName / Params</li>
<li>调用 <code>Phalcon\Mvc\View-&gt;finish()</code>结束缓冲区的接收</li>
</ul>
</li>
<li>准备响应<ul>
<li>将<code>Phalcon\Mvc\View-&gt;getContent()</code>通过<code>Phalcon\Http\Response-&gt;setContent()</code>放入Response</li>
<li>触发事件 <code>application:beforeSendResponse</code></li>
<li>调用<code>Phalcon\Http\Response-&gt;sendHeaders()</code>发送头部</li>
<li>调用<code>Phalcon\Http\Response-&gt;sendCookies()</code>发送Cookie</li>
<li>将准备好的响应作为<code>$application-&gt;handle()</code>的返回值返回</li>
</ul>
</li>
</ul>
</li>
<li>发送响应<ul>
<li><code>echo $application-&gt;handle()-&gt;getContent();</code></li>
</ul>
</li>
</ul>
<h3 id="MVC事件"><a href="#MVC事件" class="headerlink" title="MVC事件"></a>MVC事件</h3><p>Phalcon作为C扩展型的框架，其优势就在于高性能，虽然我们可以通过上一种方法自己实现整个启动，但更好的方式仍然是避免替换框架本身的内容，而使用事件驱动。</p>
<p>下面梳理了整个MVC流程中所涉及的可被监听的事件，可以根据不同需求选择对应事件作为切入点：</p>
<ul>
<li>DI注入<ul>
<li><code>application:boot</code> 应用启动</li>
</ul>
</li>
<li>路由阶段<ul>
<li>模块启动</li>
<li><code>application:beforeStartModule</code> 模块启动前</li>
<li><code>application:afterStartModule</code> 模块启动后</li>
</ul>
</li>
<li>分发阶段<ul>
<li><code>application:beforeHandleRequest</code>进入分发器前</li>
<li>开始分发<ul>
<li><code>dispatch:beforeDispatchLoop</code> 分发循环开始前</li>
<li><code>dispatch:beforeDispatch</code> 单次分发开始前</li>
<li><code>dispatch:beforeExecuteRoute</code> Action执行前</li>
<li><code>dispatch:afterExecuteRoute</code> Action执行后</li>
<li><code>dispatch:beforeNotFoundAction</code> 找不到Action</li>
<li><code>dispatch:beforeException</code> 抛出异常前</li>
<li><code>dispatch:afterDispatch</code> 单次分发结束</li>
<li><code>dispatch:afterDispatchLoop</code> 分发循环结束</li>
</ul>
</li>
<li><code>application:afterHandleRequest</code> 分发结束</li>
</ul>
</li>
<li>渲染阶段<ul>
<li><code>application:viewRender</code> 渲染开始前</li>
</ul>
</li>
<li>发送响应<ul>
<li><code>application:beforeSendResponse</code> 最终响应发送前</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liluoao.github.io/2018/03/Phalcon启动流程/" data-id="cjgx2ycis001j58mj7jheg7l1" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/phalcon/">phalcon</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/03/什么是JWT/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          什么是 JWT
        
      </div>
    </a>
  
  
    <a href="/2018/03/MySQL优化那些事/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">MySQL优化那些事儿</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/05/Laravel的Task-Scheduling/">Laravel的Task-Scheduling</a>
          </li>
        
          <li>
            <a href="/2018/05/Laravel的Artisan/">Laravel的Artisan</a>
          </li>
        
          <li>
            <a href="/2018/05/Laravel的Queue/">Laravel的Queue</a>
          </li>
        
          <li>
            <a href="/2018/05/Laravel的Eloquent-ORM-Relationship/">Laravel的Eloquent-ORM-Relationship</a>
          </li>
        
          <li>
            <a href="/2018/05/Laravel的Log/">Laravel的Log</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/laravel/">laravel</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/phalcon/">phalcon</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/wechat/">wechat</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/apache/">apache</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/array/">array</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ci/">ci</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clean-code/">clean-code</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composer/">composer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/culture/">culture</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dependency-injection/">dependency-injection</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design-patterns/">design-patterns</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/laravel/">laravel</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/phalcon/">phalcon</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/phpstorm/">phpstorm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postman/">postman</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/refactor/">refactor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/restful/">restful</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sapi/">sapi</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solid/">solid</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wechat/">wechat</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/安全/">安全</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">4</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">20</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">5</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <div class="footer-about-me">
        关于作者<br>
        <a href="https://github.com/liluoao" target="_blank" title="GitHub">GitHub</a><br>
        <a href="https://segmentfault.com/u/liluoao" target="_blank" title="SegmentFault">SegmentFault</a><br>
        <a href="https://laravel-china.org/users/7144" target="_blank" title="LaravelChina">LaravelChina</a><br>
        <a href="https://gitee.com/liluoao" target="_blank" title="码云">码云</a><br>
        <a href="https://juejin.im/user/5a19374cf265da4332274600" target="_blank" title="掘金">掘金</a><br>
        <a href="https://packagist.org/users/liluoao/" target="_blank" title="Packagist">Packagist</a><br>
        <a href="https://www.gitbook.com/@liluoao" target="_blank" title="GitBook">GitBook</a>
      </div>
      <div style="width:300px;margin:0 auto; padding:20px 0;">
        <div class="footer-copyright">
          &copy; 2018 李罗奥
          Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        </div>
        <a href="http://www.miitbeian.gov.cn/" target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">鄂ICP备18009105号</p></a>
        <a target="_blank" href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=42011102001595" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="/css/images/beian.png" style="float:left;"/><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">鄂公网安备 42011102001595号</p></a>
      </div>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">文章列表</a>
  
    <a href="/categories/laravel" class="mobile-nav-link">Laravel</a>
  
    <a href="/categories/phalcon" class="mobile-nav-link">Phalcon</a>
  
    <a href="/categories/wechat" class="mobile-nav-link">Wechat</a>
  
    <a href="/me.html" class="mobile-nav-link">关于作者</a>
  
</nav>
    

<script src="//lib.sinaapp.com/js/jquery/3.1.0/jquery-3.1.0.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>